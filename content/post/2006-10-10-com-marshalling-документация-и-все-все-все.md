---
author: admin
date: 2006-10-09T17:03:25-07:00
aliases:
- /2006/10/09/80
title: COM marshalling, документация и все, все, все...
slug: 80
tags:
- COM
- Программирование
- Microsoft
---

Все-таки, наверное, Европейский Суд не зря судит Microsoft за недостаточно хорошую документацию. Пытаясь разобраться как, все таки, написать proxy для интерфейса IShellLinkDataList (см. предыдущие посты: [COM Marshalling.](http://blog.not-a-kernel-guy.com/2006/10/07/78) и [Shortcuts, shell and COM apartments.](http://blog.not-a-kernel-guy.com/2006/10/04/76)), перечитал уйму документации, пока не нашел толкового описания того, что я хочу сделать на сайте [Dr. Dobb's](http://www.ddj.com/dept/windows/184416483). Если попытаться описать весь процесс "метаний", то выглядело это так:

<!--more-->Началось всё с идеи написать .idl с описанием интерфейса, сгенерировать proxy и stub и собрать dll. Однако с ходу это не заработало из-за того, что [IShellLinkDataList::CopyDataBlock](http://windowssdk.msdn.microsoft.com/en-gb/library/ms632701.aspx) возвращает указатель на выделенный блок переменного размера, который нужно освобождать вызовом LocalFree.

Выяснив в MSDN как, собственно, работает marshalling, я уже было начал писать полностью свой proxy. Впрочем вскоре в голову пришла разумная мысль, что не может быть все так плохо и должен существовать способ кастомизировать то, что герерирует MIDL. Снова полез в MSDN. 

Долго ли, коротко ли, увидел упоминание функций [midl_user_allocate](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/midl/midl/midl_user_allocate_1.asp) и [midl_user_free](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/midl/midl/midl_user_free_1.asp). Подумал - вот оно! Оказалось - ничего подобного. Мне даже не удалось заставить компилятор использовать эти функции. Подозреваю, что их использование ограничивается RPC и когда речь идет о COM интерфейсах они не используются. Всё таки для меня это темный лес. :-(

Продолжая копаться в MSDN и проклиная все на свете, нашел наконец статью, про MIDL аттрибут [wire_marshal](http://msdn.microsoft.com/library/default.asp?url=/library/en-us/midl/midl/wire_marshal.asp), который, как я понимаю, и нужно использовать вклинивания в процесс передачи параметров. 

Вот здесь, по идее, я должен был, наконец, быстренько написать рабочий код, изредка сверяясь с MSDN. Как бы не так. В MSDN этот вопрос освещен настолько мутно, что ни черта не понятно как же все таки использовать этот грешный аттрибут. Вдумчивое штудирование "wtypes.idl" из Platform SDK, который вовсю использует wire_marshal для сходных целей не помогло. Помогло только найденная статься в Dr. Dobb's, о которой я упоминал выше.

Так вот к чем это я все. На протяжении всего процесса поисков меня не покидало ощущение, что все на что годна документация - это перечисление названий всех функций, аттрибутов и ключей компилятора. Чего не хватало, так это внятного (да хоть какого-нибудь) описания как все описанные вещи взаимодействуют друг с другом. Толковые описания - те которые не толкут воду в ступе несколько страниц и описывают важные детали вместо ссылок на оглавление функций - можно пересчитать по пальцам однй руки и позаимствованы они из различных книг или статей. Т.е. изначально они не часть MSDN и попали они туда, потому что своих нет. При всем при этом сама реализация "в коде" и возможности, которые она предоставляет, впечатляет. Видно, что разработчики подумали о самых разных вещах и ситуациях. В общем есть еще над чем работать. :-(
